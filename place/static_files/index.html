<!doctype html>
<html lang="en"> 
	<head>
		<meta charset="UTF-8" />
  	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  	<meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

		<title>r/place clone</title>

		<script src="jquery-3.1.1.min.js"></script>
		<script type="text/javascript">
	
			var socket;

			// Hoist these functions on load
			$(function() {

				// Make a socket connection to 8081
				socket = new WebSocket("ws://" + window.location.hostname + ":8081");

				// Don't know what this is for honestly
				socket.onopen = function(event) {
					$('#sendButton').removeAttr('disabled');
					console.log("connected");
				};

				// Get some info on how the socket connection was closed
				socket.onclose = function(event) {
					alert("closed code:" + event.code + " reason:" +event.reason + " wasClean:"+event.wasClean);
				};

				// Get updates from the board
				// Need to translate binary data into usable data
				socket.onmessage = async function(message) {
					
					// Get the metadata for the pixel colours received
					var buffer = await message.data.arrayBuffer();
					const update = new Uint8ClampedArray(buffer);
					let x = update[0];
					let y = update[1];
					let width = update[2];
					let codes = update.slice(3);

					console.log("===========RECEIVING==============");
					console.log("x:", x, "y:", y, "width:", width);
					console.log("First colour code:", codes[0]);
					console.log("Number of pixels:", codes.length);
					console.log("===========RECEIVED===============");

					// Make an array with RGB values for each colour code
					let colours = new Uint8ClampedArray(codes.length * 4);
					let j = 0;
					for (let i = 0; i < colours.length; i += 4) {
						let rgb = colourMap[codes[j]];
						// console.log("RGB =", rgb, "for code:", codes[j]);
						colours[i] = rgb[0];
						colours[i+1] = rgb[1];
						colours[i+2] = rgb[2];
						colours[i+3] = 255;
						j++;
					}
				
					

					// Make an image data object
					let imageData = new ImageData(colours, width);

					// Put this image data into the canvas
					var context = document.getElementById('canvas').getContext('2d');
					context.putImageData(imageData, x, y);

					// var update = readBytes(message);

					// var pixelBuffer = new Uint8ClampedArray(message.data);

					// // Need a way to differentiate between 1 pixel update and the whole board
					// Maybe we can have this length stored in the message
					// var imageData = new ImageData(pixelBuffer, ??)

					// var context = document.getElementById('canvas').getContext('2d');
					// var imageData = context.getImageData(0, 0, 500, 500);




					// var o=JSON.parse(message.data);
					// var context = document.getElementById('canvas').getContext('2d');
					// context.fillStyle = 'rgb('+o.r+','+o.g+','+o.b+')';
		   		// context.fillRect(o.x, o.y, 2, 2);
				}

				// Auto-send any mouse movement over the board to the server
				// May comment this out later
				$('#canvas').mousemove(function(event){
					var x = event.pageX-this.offsetLeft;
					var y = event.pageY-this.offsetTop;

					// Binary buffer to send to the server
					// index 0 & 1 => x and y, 2 => colour code
					var update = new Uint8Array(4);
					update[0] = parseInt(x);
					update[1] = parseInt(y);
					update[2] = 1;
					update[3] = code;
					console.log("==============SENDING================");
					console.log("x, y, num, code =", update[0], update[1], update[2], update[3]);
					console.log("==============SENT===================");
					socket.send(update.buffer);

					// var o = { 'x': x, 'y': y, 'r': colour.r, 'g': colour.g, 'b': colour.b };
					// socket.send(JSON.stringify(o));
				});

				// Submit the pixel change
				$('#setForm').submit(function( event ) {
					// var o = { 
					// 	'x': $('#x').val(), 
					// 	'y': $('#y').val(), 
					// 	'r': colour.r,
					// 	'g': colour.g,
					// 	'b': colour.b
					// }

					// for(var key in o){
					// 	o[key]=parseInt(o[key]);
					// }
					// socket.send(JSON.stringify(o));
					var x = $('#x').val();
					var y = $('#y').val();
					var update = new Uint8Array(4);
					update[0] = parseInt(x);
					update[1] = parseInt(y);
					update[2] = 1;
					update[3] = code;
					console.log("================SENDING================");
					console.log("x, y, num, code =", update[0], update[1], update[2], update[3]);
					console.log("================SENT===================");
					socket.send(update);
  				event.preventDefault();
				});
				
			});

			// Mapping from 16 colours to rgb values
			var colourMapping = {
				0: { 'r': 0, 'g': 0, 'b': 0 },
				1: { 'r': 128, 'g': 128, 'b': 128 },
				2: { 'r': 211, 'g': 211, 'b': 211 },
				3: { 'r': 255, 'g': 255, 'b': 255 },
				4: { 'r': 54, 'g': 52, 'b': 163 },
				5: { 'r': 137, 'g': 68, 'b': 171 },
				6: { 'r': 0, 'g': 64, 'b': 221 },
				7: { 'r': 112, 'g': 215, 'b': 255 },
				8: { 'r': 215, 'g': 0, 'b': 21 },
				9: { 'r': 255, 'g': 100, 'b': 130 },
				10: { 'r': 255, 'g': 179, 'b': 64 },
				11: { 'r': 255, 'g': 212, 'b': 38 },
				12: { 'r': 165, 'g': 42, 'b': 42 },
				13: { 'r': 36, 'g': 128, 'b': 61 },
				14: { 'r': 48, 'g': 219, 'b': 91 },
				15: { 'r': 210, 'g': 184, 'b': 140 }
			}

			var colourMap = {
				0: [0, 0, 0],
				1: [128, 128, 128],
				2: [211, 211, 211],
				3: [255, 255, 255],
				4: [54, 52, 163],
				5: [137, 68, 221],
				6: [0, 64, 221],
				7: [112, 215, 255],
				8: [215, 0, 21],
				9: [255, 100, 130],
				10: [255, 179, 64],
				11: [255, 212, 38],
				12: [165, 42, 42],
				13: [36, 128, 61],
				14: [48, 219, 91],
				15: [210, 184, 140]
			}
			
			// Store the current selected colour
			var colour = { 'r': 255, 'g': 255, 'b': 255 }
			var code = 3;
			
			// Let users know what colour they have selected
			function changeColour(id) {
				code = id;
				$("#colourbox").removeClass();
				$("#colourbox").addClass('c' + id);
			}
	
		</script>

		<style>
      body {
				text-align: center;
				align: center;
				overflow: hidden;
				margin: 0px;
				padding: 0px;
			}

			canvas {
				border: 1px solid black;
			}

			input[type=number]{ 
				width: 3em; 
			}

			#colourmenu {
				align-self: center;
			}

			#colourbox {
				height: 30px;
				width: 30px;
				border: 2px solid rgb(0, 0, 0);
				display: inline-block;
			}

			.c0 {background-color: rgb(0, 0, 0);}
			.c1 {background-color: rgb(128, 128, 128);}
			.c2 {background-color: rgb(211, 211, 211);}
			.c3 {background-color: rgb(255, 255, 255);}

			.c4 {background-color: rgb(54, 52, 163);}
			.c5 {background-color: rgb(137, 68, 171);}
			.c6 {background-color: rgb(0, 64, 221);}
			.c7 {background-color: rgb(112, 215, 255);}

			.c8 {background-color: rgb(215, 0, 21);}
			.c9 {background-color: rgb(255, 100, 130);}
			.c10 {background-color: rgb(255, 179, 64);}
			.c11 {background-color: rgb(255, 212, 38);}

			.c12 {background-color: rgb(165, 42, 42);}
			.c13 {background-color: rgb(36, 138, 61);}
			.c14 {background-color: rgb(48, 219, 91);}
			.c15 {background-color: rgb(210, 184, 140);}

			#palette {
				align-self: center;
				border: 1px solid red;
				margin: 0 auto;
				padding: 0px
			}

			#palette tr, td {
  			padding: 0px;
			}

			#palette button {
				height: 50px;
				width: 50px;
				/* border: none; */
				border: 2px solid transparent;
				border-style: inset;
			}

			#palette button:hover {
				cursor: pointer;
				border: 2px solid rgba(0, 0, 0, 0.5);
			}

			#c0 {background-color: rgb(0, 0, 0);}
			#c1 {background-color: rgb(128, 128, 128);}
			#c2 {background-color: rgb(211, 211, 211);}
			#c3 {background-color: rgb(255, 255, 255);}

			#c4 {background-color: rgb(54, 52, 163);}
			#c5 {background-color: rgb(137, 68, 171);}
			#c6 {background-color: rgb(0, 64, 221);}
			#c7 {background-color: rgb(112, 215, 255);}

			#c8 {background-color: rgb(215, 0, 21);}
			#c9 {background-color: rgb(255, 100, 130);}
			#c10 {background-color: rgb(255, 179, 64);}
			#c11 {background-color: rgb(255, 212, 38);}

			#c12 {background-color: rgb(165, 42, 42);}
			#c13 {background-color: rgb(36, 138, 61);}
			#c14 {background-color: rgb(48, 219, 91);}
			#c15 {background-color: rgb(210, 184, 140);}

		</style>
	</head>
	<body>
		<h1>r/place clone</h1>

		<canvas id="canvas" width="250" height="250" ></canvas>
		<form id="setForm">
			(<input type="number" id="x" placeholder="x" min="0" max="250">,
			<input type="number" id="y" placeholder="y" min="0" max="250">)
			&nbsp; &nbsp; &nbsp;
			<input type="submit" name="set" value="set"/>
		</form>

		<div id="colourmenu">
			<h3>Pick a colour:</h3>
			<span id="colourbox"></span>
		</div>

		<div>
			<table id="palette" cellspacing="0">
				<tr>
					<td><button id="c0" value="Inset Border" onclick="changeColour(0)"></button></td>
					<td><button id="c1" value="Inset Border" onclick="changeColour(1)"></button></td>
					<td><button id="c2" value="Inset Border" onclick="changeColour(2)"></button></td>
					<td><button id="c3" value="Inset Border" onclick="changeColour(3)"></button></td>
					<td><button id="c4" value="Inset Border" onclick="changeColour(4)"></button></td>
					<td><button id="c5" value="Inset Border" onclick="changeColour(5)"></button></td>
					<td><button id="c6" value="Inset Border" onclick="changeColour(6)"></button></td>
					<td><button id="c7" value="Inset Border" onclick="changeColour(7)"></button></td>
				</tr>
				<tr>
					<td><button id="c8" value="Inset Border"  onclick="changeColour(8)"></button></td>
					<td><button id="c9" value="Inset Border"  onclick="changeColour(9)"></button></td>
					<td><button id="c10" value="Inset Border" onclick="changeColour(10)"></button></td>
					<td><button id="c11" value="Inset Border" onclick="changeColour(11)"></button></td>
					<td><button id="c12" value="Inset Border" onclick="changeColour(12)"></button></td>
					<td><button id="c13" value="Inset Border" onclick="changeColour(13)"></button></td>
					<td><button id="c14" value="Inset Border" onclick="changeColour(14)"></button></td>
					<td><button id="c15" value="Inset Border" onclick="changeColour(15)"></button></td>
				</tr>
			</table>
		</div>



	</body>
</html>
